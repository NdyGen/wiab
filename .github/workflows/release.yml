name: Publish App to App store

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (X.Y.Z format, e.g., 1.0.3)'
        required: true
        type: string
      changelog:
        description: 'Changelog entry for this release'
        required: true
        type: string

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  # ==========================================================================
  # Phase 1: Input Validation (Fail Fast)
  # ==========================================================================
  validate:
    name: 'Phase 1: Validate Inputs'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate-version.outputs.version }}
      tag: ${{ steps.validate-version.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Validate version format
        id: validate-version
        run: |
          VERSION="${{ github.event.inputs.version }}"

          # Validate semver format
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::‚ùå Invalid version format: $VERSION"
            echo "Version must be in X.Y.Z format (e.g., 1.0.3)"
            exit 1
          fi

          echo "‚úÖ Valid version format: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=v$VERSION" >> $GITHUB_ENV

      - name: Validate changelog
        run: |
          CHANGELOG="${{ github.event.inputs.changelog }}"

          if [ -z "$CHANGELOG" ]; then
            echo "::error::‚ùå Changelog cannot be empty"
            exit 1
          fi

          if [ ${#CHANGELOG} -lt 10 ]; then
            echo "::warning::‚ö†Ô∏è Changelog is very short (${#CHANGELOG} characters)"
            echo "Consider providing a more detailed description"
          fi

          echo "‚úÖ Changelog provided: ${#CHANGELOG} characters"

      - name: Check version uniqueness
        run: |
          if grep -q '"${{ env.VERSION }}"' .homeychangelog.json; then
            echo "::error::‚ùå Version ${{ env.VERSION }} already exists in changelog"
            echo "Please use a different version number"
            exit 1
          fi

          echo "‚úÖ Version ${{ env.VERSION }} is unique"

      - name: Compare with current version
        run: |
          # Install dependencies to read package.json
          npm ci

          CURRENT_VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "Current version: $CURRENT_VERSION"
          echo "New version: ${{ env.VERSION }}"

          # Simple version comparison (splits on '.' and compares numerically)
          IFS='.' read -r -a NEW <<< "${{ env.VERSION }}"
          IFS='.' read -r -a CURR <<< "$CURRENT_VERSION"

          if [[ ${NEW[0]} -lt ${CURR[0]} ]] || \
             [[ ${NEW[0]} -eq ${CURR[0]} && ${NEW[1]} -lt ${CURR[1]} ]] || \
             [[ ${NEW[0]} -eq ${CURR[0]} && ${NEW[1]} -eq ${CURR[1]} && ${NEW[2]} -le ${CURR[2]} ]]; then
            echo "::error::‚ùå Version ${{ env.VERSION }} is not greater than current version $CURRENT_VERSION"
            exit 1
          fi

          echo "‚úÖ Version ${{ env.VERSION }} > $CURRENT_VERSION"

      - name: Verify branch is main
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$BRANCH" != "main" ]; then
            echo "::error::‚ùå Must run release from main branch (current: $BRANCH)"
            exit 1
          fi

          echo "‚úÖ Running from main branch"

      - name: Validation summary
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ‚úÖ Phase 1: Validation Passed

          - **Version**: ${{ env.VERSION }}
          - **Tag**: ${{ env.TAG }}
          - **Changelog**: ${{ github.event.inputs.changelog }}
          - **Branch**: main
          - **Status**: All validation checks passed
          EOF

  # ==========================================================================
  # Phase 2: Quality Assurance (Build & Test)
  # ==========================================================================
  quality-assurance:
    name: 'Phase 2: Quality Assurance'
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          echo "‚úÖ Dependencies installed"

      - name: Build TypeScript
        run: |
          npm run build
          echo "‚úÖ TypeScript build successful"

      - name: Run linter
        run: |
          npm run lint
          echo "‚úÖ Linting passed"

      - name: Run tests
        run: |
          npm test
          echo "‚úÖ Tests passed"

      - name: Build Homey app
        run: |
          npm run homey:build
          echo "‚úÖ Homey app.json generated"

      - name: Validate Homey app
        run: |
          npx homey app validate
          echo "‚úÖ Homey app validation passed"

      - name: Quality assurance summary
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ‚úÖ Phase 2: Quality Assurance Passed

          - **Build**: ‚úÖ Success
          - **Linter**: ‚úÖ Passed
          - **Tests**: ‚úÖ Passed
          - **Homey Validation**: ‚úÖ Passed
          - **Ready for release**: Yes
          EOF

  # ==========================================================================
  # Phase 3: Update Version and Create Release (Consolidated)
  # ==========================================================================
  update-version-and-release:
    name: 'Phase 3: Update Version and Create Release'
    runs-on: ubuntu-latest
    needs: [validate, quality-assurance]
    env:
      VERSION: ${{ needs.validate.outputs.version }}
      TAG: ${{ needs.validate.outputs.tag }}
    outputs:
      pr-number: ${{ steps.create-pr.outputs.pr-number }}
      merge-sha: ${{ steps.merge-pr.outputs.merge-sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create backup
        id: backup
        run: |
          TIMESTAMP=$(date +%s)
          BACKUP_DIR=".backup-${TIMESTAMP}"
          mkdir -p "${BACKUP_DIR}"

          echo "Creating backup in ${BACKUP_DIR}..."
          cp package.json "${BACKUP_DIR}/package.json"
          cp .homeycompose/app.json "${BACKUP_DIR}/app.json"
          cp .homeychangelog.json "${BACKUP_DIR}/changelog.json"

          echo "BACKUP_PATH=${BACKUP_DIR}" >> $GITHUB_ENV
          echo "‚úÖ Backup created: ${BACKUP_DIR}"

      - name: Update package.json
        run: |
          npm version ${{ env.VERSION }} --no-git-tag-version --allow-same-version
          echo "‚úÖ Updated package.json to ${{ env.VERSION }}"

      - name: Update .homeycompose/app.json
        run: |
          node -e "
            const fs = require('fs');
            const appJson = JSON.parse(fs.readFileSync('.homeycompose/app.json', 'utf8'));
            appJson.version = '${{ env.VERSION }}';
            fs.writeFileSync('.homeycompose/app.json', JSON.stringify(appJson, null, 2) + '\n');
          "
          echo "‚úÖ Updated .homeycompose/app.json to ${{ env.VERSION }}"

      - name: Update .homeychangelog.json
        run: |
          node -e "
            const fs = require('fs');
            const changelog = JSON.parse(fs.readFileSync('.homeychangelog.json', 'utf8'));
            changelog['${{ env.VERSION }}'] = {
              'en': \`${{ github.event.inputs.changelog }}\`
            };
            fs.writeFileSync('.homeychangelog.json', JSON.stringify(changelog, null, 2) + '\n');
          "
          echo "‚úÖ Updated .homeychangelog.json with new entry"

      - name: Rebuild Homey app.json
        run: |
          npm run homey:build
          echo "‚úÖ Rebuilt app.json with updated version"

      - name: Validate updated files
        run: |
          # Verify package.json
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [ "$PKG_VERSION" != "${{ env.VERSION }}" ]; then
            echo "::error::‚ùå package.json version mismatch: $PKG_VERSION"
            exit 1
          fi

          # Verify .homeycompose/app.json
          APP_VERSION=$(node -p "require('./.homeycompose/app.json').version")
          if [ "$APP_VERSION" != "${{ env.VERSION }}" ]; then
            echo "::error::‚ùå app.json version mismatch: $APP_VERSION"
            exit 1
          fi

          # Verify .homeychangelog.json
          CHANGELOG_EXISTS=$(node -p "Object.keys(require('./.homeychangelog.json')).includes('${{ env.VERSION }}')")
          if [ "$CHANGELOG_EXISTS" != "true" ]; then
            echo "::error::‚ùå Changelog entry missing for ${{ env.VERSION }}"
            exit 1
          fi

          echo "‚úÖ All version updates validated successfully"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create release branch
        id: create-branch
        run: |
          BRANCH_NAME="release/v${{ env.VERSION }}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          echo "branch-name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          git checkout -b "${BRANCH_NAME}"
          echo "‚úÖ Created branch: ${BRANCH_NAME}"

      - name: Stage files
        run: |
          git add package.json package-lock.json .homeycompose/app.json .homeychangelog.json
          git status

      - name: Commit changes
        id: commit
        run: |
          git commit -m "chore(release): v${{ env.VERSION }}

          ${{ github.event.inputs.changelog }}

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit-sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_ENV
          echo "‚úÖ Committed version updates"
          echo "Commit SHA: ${COMMIT_SHA}"

      - name: Push release branch
        run: |
          git push origin ${{ env.BRANCH_NAME }}
          echo "‚úÖ Pushed branch to origin"

      - name: Create pull request
        id: create-pr
        run: |
          PR_BODY="## Release v${{ env.VERSION }}

          This is an automated release PR created by the release workflow.

          ### Changes
          - Updated version to ${{ env.VERSION }}
          - Added changelog entry

          ### Changelog
          ${{ github.event.inputs.changelog }}

          ### Validation
          ‚úÖ All quality checks passed in workflow

          ---
          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)"

          PR_NUMBER=$(gh pr create \
            --title "chore(release): v${{ env.VERSION }}" \
            --body "$PR_BODY" \
            --base main \
            --head ${{ env.BRANCH_NAME }} \
            | grep -oP '(?<=/pull/)\d+')

          echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV
          echo "‚úÖ Created PR #${PR_NUMBER}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge pull request
        id: merge-pr
        run: |
          echo "‚ÑπÔ∏è Quality checks already passed in Phase 2"
          echo "‚ÑπÔ∏è PR contains only version updates - safe to merge directly"

          # Merge the PR
          gh pr merge ${{ env.PR_NUMBER }} --squash --delete-branch

          echo "‚úÖ PR #${{ env.PR_NUMBER }} merged successfully"

          # Get merge commit SHA
          MERGE_SHA=$(gh pr view ${{ env.PR_NUMBER }} --json mergeCommit --jq '.mergeCommit.oid')
          echo "merge-sha=${MERGE_SHA}" >> $GITHUB_OUTPUT
          echo "MERGE_SHA=${MERGE_SHA}" >> $GITHUB_ENV
          echo "Merge commit: ${MERGE_SHA}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create git tag
        run: |
          # Pull the latest main branch (which includes the merge commit)
          git fetch origin main
          git checkout main
          git pull origin main

          # Verify we have the correct merge commit
          CURRENT_SHA=$(git rev-parse HEAD)
          if [ "$CURRENT_SHA" != "${{ env.MERGE_SHA }}" ]; then
            echo "::error::Current SHA $CURRENT_SHA doesn't match merge SHA ${{ env.MERGE_SHA }}"
            exit 1
          fi

          # Verify changelog entry exists
          if ! grep -q '"${{ env.VERSION }}"' .homeychangelog.json; then
            echo "::error::Changelog entry for ${{ env.VERSION }} not found in .homeychangelog.json"
            echo "Contents of .homeychangelog.json:"
            cat .homeychangelog.json
            exit 1
          fi

          echo "‚úÖ Verified merge commit and changelog entry"

          # Create annotated tag
          git tag -a "${{ env.TAG }}" -m "Release ${{ env.TAG }}

          ${{ github.event.inputs.changelog }}"

          # Push tag
          git push origin ${{ env.TAG }}
          echo "‚úÖ Created and pushed tag ${{ env.TAG }}"

      - name: Phase 3 summary
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ‚úÖ Phase 3: Version Update and Release Completed

          - **Version**: ${{ env.VERSION }}
          - **Branch**: ${{ env.BRANCH_NAME }}
          - **PR Number**: #${{ env.PR_NUMBER }}
          - **Merge Commit**: ${{ env.MERGE_SHA }}
          - **Tag**: ${{ env.TAG }}
          - **Files Updated**:
            - package.json
            - package-lock.json
            - .homeycompose/app.json
            - .homeychangelog.json
          - **Status**: Merged to main and tagged
          EOF

      - name: Cleanup on failure
        if: failure()
        run: |
          echo "‚ùå Release failed - attempting cleanup..."

          # Restore from backup
          if [ -d "${{ env.BACKUP_PATH }}" ]; then
            cp ${{ env.BACKUP_PATH }}/package.json package.json || true
            cp ${{ env.BACKUP_PATH }}/app.json .homeycompose/app.json || true
            cp ${{ env.BACKUP_PATH }}/changelog.json .homeychangelog.json || true
            echo "‚úÖ Files restored from backup"
          fi

          # Close PR if it exists
          if [ -n "${{ env.PR_NUMBER }}" ]; then
            gh pr close ${{ env.PR_NUMBER }} || true
            echo "‚úÖ Closed PR #${{ env.PR_NUMBER }}"
          fi

          # Delete release branch if it exists
          if git ls-remote --heads origin ${{ env.BRANCH_NAME }} | grep -q ${{ env.BRANCH_NAME }}; then
            git push origin --delete ${{ env.BRANCH_NAME }} || true
            echo "‚úÖ Deleted branch ${{ env.BRANCH_NAME }}"
          fi

          # Delete tag if it was created
          if git ls-remote --tags origin ${{ env.TAG }} | grep -q ${{ env.TAG }}; then
            git push origin --delete ${{ env.TAG }} || true
            echo "‚úÖ Deleted tag ${{ env.TAG }}"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Phase 4: Homey App Store Publish (External Service)
  # ==========================================================================
  publish-homey:
    name: 'Phase 4: Publish to Homey App Store'
    runs-on: ubuntu-latest
    needs: [validate, update-version-and-release]
    env:
      VERSION: ${{ needs.validate.outputs.version }}
      TAG: ${{ needs.validate.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.validate.outputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for publishing
        run: |
          npm run build
          npm run homey:build

      - name: Validate before publish
        run: |
          npx homey app validate
          echo "‚úÖ Pre-publish validation passed"

      - name: Publish to Homey App Store
        id: publish
        uses: athombv/github-action-homey-app-publish@master
        with:
          personal_access_token: ${{ secrets.HOMEY_BEARER_TOKEN }}

      - name: Verify publish success
        run: |
          if [ "${{ steps.publish.outcome }}" != "success" ]; then
            echo "::error::‚ùå Homey App Store publish failed"
            exit 1
          fi

          echo "‚úÖ Published to Homey App Store"

      - name: Publish summary
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ‚úÖ Phase 4: Homey App Store Publish Completed

          - **Version**: ${{ env.VERSION }}
          - **Status**: Published Successfully
          - **App Store Link**: https://homey.app/nl-nl/app/net.dongen.wiab/Wasp-in-a-Box/
          - **Publish Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF

      - name: Document failure state
        if: failure()
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ‚ö†Ô∏è Phase 4: Publish Failed - Manual Intervention Required

          ### Current State
          - Version: ${{ env.VERSION }}
          - Merge SHA: ${{ needs.update-version-and-release.outputs.merge-sha }}
          - PR: #${{ needs.update-version-and-release.outputs.pr-number }}
          - Tag: ${{ env.TAG }}
          - Git: ‚úÖ Merged and tagged
          - Homey App Store: ‚ùå Failed

          ### Manual Recovery Steps

          1. **Verify Git State**
             \`\`\`bash
             git fetch --tags
             git checkout ${{ env.TAG }}
             \`\`\`

          2. **Manual Publish**
             \`\`\`bash
             npm ci
             npm run build
             npm run homey:build
             npx homey app publish
             \`\`\`

          3. **If Publish Succeeds**
             - Continue to GitHub release creation manually
             - Mark workflow as resolved

          4. **If Complete Rollback Needed**
             \`\`\`bash
             # Delete tag
             git push --delete origin ${{ env.TAG }}
             git tag -d ${{ env.TAG }}

             # Reset commit
             git reset --hard HEAD~1
             git push --force origin main
             \`\`\`

          ### Support
          Check logs above for detailed error information.
          EOF

  # ==========================================================================
  # Phase 5: GitHub Release Creation
  # ==========================================================================
  create-release:
    name: 'Phase 5: Create GitHub Release'
    runs-on: ubuntu-latest
    needs: [validate, update-version-and-release, publish-homey]
    env:
      VERSION: ${{ needs.validate.outputs.version }}
      TAG: ${{ needs.validate.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.validate.outputs.tag }}
          fetch-depth: 0

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG }}
          release_name: Release ${{ env.TAG }}
          body: |
            ## Changelog

            ${{ github.event.inputs.changelog }}

            ## Installation

            This version has been published to the Homey App Store.
            Install or update via the Homey mobile app or web interface.

            ## Links

            - [App Store](https://homey.app/nl-nl/app/net.dongen.wiab/Wasp-in-a-Box/)
            - [Documentation](https://github.com/NdyGen/wiab/blob/main/README.md)
            - [Community Forum](https://community.homey.app/t/app-pro-wasp-in-a-box-wiab/147021)
          draft: false
          prerelease: false

      - name: Release summary
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ‚úÖ Phase 5: GitHub Release Created

          - **Release**: ${{ env.TAG }}
          - **Changelog**: ${{ github.event.inputs.changelog }}
          - **URL**: https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG }}
          EOF

  # ==========================================================================
  # Success Notification (All Phases Complete)
  # ==========================================================================
  notify-success:
    name: 'Release Successful'
    runs-on: ubuntu-latest
    needs: [validate, quality-assurance, update-version-and-release, publish-homey, create-release]
    if: success()
    env:
      VERSION: ${{ needs.validate.outputs.version }}
      TAG: ${{ needs.validate.outputs.tag }}
    steps:
      - name: Success notification
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          # üéâ Release Successful!

          ## Version ${{ env.VERSION }} Released

          All phases completed successfully:
          - ‚úÖ Phase 1: Input Validation
          - ‚úÖ Phase 2: Quality Assurance
          - ‚úÖ Phase 3: Version Update & Release
          - ‚úÖ Phase 4: Homey App Store Publish
          - ‚úÖ Phase 5: GitHub Release

          ## Links
          - **Homey App Store**: https://homey.app/nl-nl/app/net.dongen.wiab/Wasp-in-a-Box/
          - **GitHub Release**: https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG }}
          - **Merge Commit**: ${{ needs.update-version-and-release.outputs.merge-sha }}
          - **Release PR**: #${{ needs.update-version-and-release.outputs.pr-number }}

          ## Next Steps
          - Monitor Homey App Store for live publication
          - Announce release in community forum if needed
          - Update documentation if required
          EOF

          echo "üéâ Successfully released ${{ env.VERSION }} to Homey App Store!"

  # ==========================================================================
  # Failure Notification
  # ==========================================================================
  notify-failure:
    name: 'Release Failed'
    runs-on: ubuntu-latest
    needs: [validate, quality-assurance, update-version-and-release, publish-homey, create-release]
    if: failure()
    steps:
      - name: Failure notification
        run: |
          cat <<EOF >> $GITHUB_STEP_SUMMARY
          # ‚ùå Release Failed

          The release workflow encountered an error. Check the failed job above for details.

          ## Recovery Steps

          1. Review the error logs in the failed phase
          2. If git operations succeeded but publish failed, see manual recovery steps in Phase 5
          3. If early phases failed, fix the issue and re-run the workflow
          4. Contact repository maintainer if assistance is needed

          ## Support

          - Check workflow logs for detailed error messages
          - Review HOW_TO_RELEASE.md for guidance
          - Open an issue if the problem persists
          EOF

          echo "‚ùå Release failed - check logs for details"
          exit 1
