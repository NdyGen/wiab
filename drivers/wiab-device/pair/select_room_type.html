<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 20px;
            margin: 0;
        }

        h1 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .intro {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .template-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .template-item {
            padding: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .template-item:hover {
            border-color: #2196F3;
            background-color: #f5f9ff;
        }

        .template-item.selected {
            border-color: #2196F3;
            background-color: #e3f2fd;
        }

        .template-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 6px;
            color: #333;
        }

        .template-description {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .template-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 4px;
            font-size: 12px;
        }

        .template-value {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .value-label {
            color: #666;
        }

        .value-number {
            font-weight: 600;
            color: #333;
        }

        .skip-button {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.2s;
        }

        .skip-button:hover {
            background: #f5f5f5;
            border-color: #999;
        }
    </style>
</head>
<body>
    <h1>Select Room Type (Optional)</h1>
    <p class="intro">
        Choose a room type to automatically configure timer values with recommended settings for that room.
        You can still adjust these values later in device settings, or skip this step to configure manually.
    </p>

    <div id="templateList" class="template-list">
        <!-- Templates will be inserted here by JavaScript -->
    </div>

    <button id="skipButton" class="skip-button">
        Skip - Configure Manually
    </button>

    <script type="application/javascript">
        (function() {
            'use strict';

            // Room templates - fetched dynamically from driver
            let ROOM_TEMPLATES = [];
            let selectedTemplateId = null;

            function onHomeyReady(Homey) {
                console.log('Homey ready, fetching room templates...');

                // Fetch templates from driver
                Homey.emit('get_room_templates', null, function(err, templates) {
                    if (err) {
                        console.error('Failed to fetch templates:', err);
                        showError('Failed to load room templates: ' + (err.message || err));
                        return;
                    }

                    ROOM_TEMPLATES = templates;
                    console.log('Loaded ' + templates.length + ' room templates');
                    renderTemplates();
                });

                // Skip button handler
                document.getElementById('skipButton').addEventListener('click', function() {
                    console.log('Skip button clicked');
                    try {
                        Homey.emit('select_room_type', null, function(err, result) {
                            if (err) {
                                console.error('Failed to skip template selection:', err);
                                alert('Failed to proceed. Please try again.');
                                return;
                            }
                            Homey.nextView();
                        });
                    } catch (error) {
                        console.error('Exception during skip:', error);
                        alert('An error occurred. Please restart pairing.');
                    }
                });
            }

            function showError(message) {
                const container = document.getElementById('templateList');
                container.innerHTML = '<div style="padding: 20px; color: red; text-align: center;">' +
                    '<strong>Error:</strong> ' + message +
                    '</div>';
            }

            function renderTemplates() {
                const container = document.getElementById('templateList');
                container.innerHTML = '';

                ROOM_TEMPLATES.forEach(function(template) {
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.setAttribute('data-template-id', template.id);

                    const nameEl = document.createElement('div');
                    nameEl.className = 'template-name';
                    nameEl.textContent = template.name;

                    const descEl = document.createElement('div');
                    descEl.className = 'template-description';
                    descEl.textContent = template.description;

                    const valuesEl = document.createElement('div');
                    valuesEl.className = 'template-values';
                    valuesEl.innerHTML =
                        '<div class="template-value">' +
                        '    <span class="value-label">Door motion window:</span>' +
                        '    <span class="value-number">' + template.timerValues.t_enter + 's</span>' +
                        '</div>' +
                        '<div class="template-value">' +
                        '    <span class="value-label">Empty timeout:</span>' +
                        '    <span class="value-number">' + template.timerValues.t_clear + 's</span>' +
                        '</div>' +
                        '<div class="template-value">' +
                        '    <span class="value-label">PIR stale timeout:</span>' +
                        '    <span class="value-number">' + template.timerValues.stalePirMinutes + 'min</span>' +
                        '</div>' +
                        '<div class="template-value">' +
                        '    <span class="value-label">Door stale timeout:</span>' +
                        '    <span class="value-number">' + template.timerValues.staleDoorMinutes + 'min</span>' +
                        '</div>';

                    item.appendChild(nameEl);
                    item.appendChild(descEl);
                    item.appendChild(valuesEl);

                    item.addEventListener('click', function() {
                        selectTemplate(template.id);
                    });

                    container.appendChild(item);
                });
            }

            function selectTemplate(templateId) {
                selectedTemplateId = templateId;
                console.log('Template selected:', templateId);

                // Update visual selection
                const items = document.querySelectorAll('.template-item');
                items.forEach(function(item) {
                    if (item.getAttribute('data-template-id') === templateId) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                });

                // Find the selected template
                const template = ROOM_TEMPLATES.find(function(t) {
                    return t.id === templateId;
                });

                if (template) {
                    console.log('Sending template timer values:', template.timerValues);
                    try {
                        // Send template timer values to driver and proceed to next view
                        Homey.emit('select_room_type', template.timerValues, function(err, result) {
                            if (err) {
                                console.error('Failed to send template to driver:', err);
                                alert('Failed to apply template. Please try again or skip this step.');
                                return;
                            }

                            if (!result || !result.success) {
                                console.error('Driver rejected template:', result);
                                alert('Template could not be applied. Continuing with default values.');
                            }

                            Homey.nextView();
                        });
                    } catch (error) {
                        console.error('Exception during template selection:', error);
                        alert('An error occurred. Please skip this step and configure manually.');
                    }
                } else {
                    console.error('Template not found:', templateId);
                    alert('Template not found. Please select another template or skip.');
                }
            }

            // Wait for Homey to be ready, then initialize
            if (typeof Homey !== 'undefined') {
                try {
                    onHomeyReady(Homey);
                } catch (error) {
                    console.error('Failed to initialize pairing page:', error);
                    document.body.innerHTML = '<div style="padding: 20px; color: red;">' +
                        '<h1>Error</h1>' +
                        '<p>Pairing framework failed to load. Please restart the Homey app and try again.</p>' +
                        '<p>If this persists, contact support with error code: HOMEY_INIT_FAILED</p>' +
                        '</div>';
                }
            } else {
                console.error('CRITICAL: Homey API not available in pairing context');
                document.body.innerHTML = '<div style="padding: 20px; color: red;">' +
                    '<h1>Error</h1>' +
                    '<p>Homey SDK not available. Please restart pairing.</p>' +
                    '<p>If this persists, contact support with error code: HOMEY_API_MISSING</p>' +
                    '</div>';
            }
        })();
    </script>
</body>
</html>
